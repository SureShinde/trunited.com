<?php
/**
 * Magestore
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magestore.com license that is
 * available through the world-wide-web at this URL:
 * http://www.magestore.com/license-agreement.html
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Magestore
 * @package     Magestore_RewardPoints
 * @copyright   Copyright (c) 2012 Magestore (http://www.magestore.com/)
 * @license     http://www.magestore.com/license-agreement.html
 */

/**
 * Rewardpoints Account Dashboard
 *
 * @see Magestore_RewardPoints_Block_Account_Dashboard
 */
?>
<?php
$collection = $this->getTruBox();
$logo = $this->getLogo();
$orders = $this->getCollection();
$truBox = Mage::helper('trubox')->getCurrentTruBox();
$is_applied_tgc = false;
if($truBox != null)
    $is_applied_tgc = $truBox->getData('use_trugiftcard') == 1 ? true : false;
?>
<div class="trubox-page">
    <?php echo $this->getChildHtml('global_messages'); ?>
    <?php if (Mage::helper('core')->isModuleOutputEnabled('Magestore_TruWallet') && Mage::helper('truwallet')->isShowWarningMessage()) { ?>
        <?php if (Mage::helper('truwallet')->getWarningMessage() != null) { ?>
            <ul class="messages">
                <li class="notice-msg">
                    <ul>
                        <li><span><?php echo Mage::helper('truwallet')->getWarningMessage(); ?></span></li>
                    </ul>
                </li>
            </ul>

        <?php } ?>
    <?php } ?>
    <div class="page-title" tabindex="1">
        <h1><?php echo $this->__('My TruBox') ?></h1>
    </div>

    <div class="info-summary">
        <?php if ($logo != null) { ?>
            <img
                    src="<?php echo Mage::getBaseUrl('media') . 'trubox' . DS . Mage::getStoreConfig('trubox/general/logo'); ?>">
        <?php } else { ?>
            <img src="<?php echo Mage::getBaseUrl('media') . 'trubox/no_image.png'; ?>">
        <?php } ?>
    </div>

    <div class="page-description">
        <?php
        echo Mage::getModel('cms/block')->load('trubox_description')->getContent();
        ?>
    </div>
    <br style="clear: both"/>
    <?php if($this->isEnableCouponCode()){?>
    <hr class="share_separate"/>
    <div class="trubox-coupon-code">
        <h2 class="trubox-header"><?php echo $this->__('TruBox Promotion Code') ?></h2>
        <?php $code = $this->hasCouponCode();?>
        <form class="items" id="trubox-coupon-code" action="<?php echo $this->saveCouponCodeUrl() ?>" method="POST">
            <?php if($code == null){?>
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="fields">
                        <div class="wide">
                            <label for="telephone" class="required"><em>*</em>
                                <?php echo $this->__('Enter promotion code') ?>
                            </label>
                            <div class="input-box">
                                <input type="text" name="coupon_code" value="" title="<?php echo $this->__('The promotion code') ?>" class="input-text required-entry"
                                       id="coupon_code" placeholder="<?php echo $this->__('Enter the promotion code') ?>">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="buttons-set">
                <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                <button class="button btn-cart" type="submit">
                    <span><span><?php echo $this->__('Save Promotion Code') ?></span></span>
                </button>
            </div>
            <?php } else {?>
                <p><?php echo Mage::helper('trubox')->__('Your promotion code is: <b>%s</b>', strtoupper($code->getCouponCode()));?></p>
            <?php }?>
        </form>
    </div>
    <?php }?>
    <hr class="share_separate"/>
    <div class="box-account box-info box-trubox-summary">
        <div class="trubox-items">
            <h2 class="trubox-header"><?php echo $this->__('Trubox Items') ?></h2>
            <?php if (sizeof($collection) > 0) { ?>
                <form class="items" action="<?php echo $this->saveItemsUrl() ?>" method="POST" id="trubox-items">
                    <div class="table-responsive">
                        <table id="shopping-cart-table" class="table table-condensed">
                            <thead>
                                <tr>
                                    <th><span class="nobr"><?php echo $this->__('') ?></span></th>
                                    <th><span class="nobr"><?php echo $this->__('Name') ?></span></th>
                                    <th>
                                        <?php echo $this->__('Qty') ?>
                                    </th>
                                    <th>
                                        <span class="nobr"><?php echo $this->__('Points') ?></span></span>
                                    </th>
                                    <th>
                                        <span class="nobr"><?php echo $this->__('Price') ?></span></span>
                                    </th>
                                    <th>
                                        <span class="nobr"><?php echo $this->__('Total Price') ?></span></span>
                                    </th>
                                    <th>
                                        <span class="nobr"><?php echo $this->__('Tax Amount') ?></span></span>
                                    </th>
                                    <th>
                                        <span class="nobr"><?php echo $this->__('Status') ?></span></span>
                                    </th>
                                    <th>
                                        <span class="nobr"><span><?php echo $this->__('Action') ?></span></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                            <?php
                            $totalPointEarn = 0;
                            $totalPrice = 0;
                            $tax = 0;
                            foreach ($collection as $item) {
                                $product = Mage::getModel('catalog/product')->load($item->getProductId());
                                $pointEarn = $this->getPointEarning($product);
                                $option_params = json_decode($item->getOptionParams(), true);
                                if ($product->getStockItem()->getIsInStock()) {
                                    $flag = false;
                                    if ($product->getTypeId() == 'configurable') {
                                        $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                            ->getProductByAttributes($option_params, $product)->getId();
                                        $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                        foreach ($childProducts as $childProduct) {
                                            $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                            if ($childProduct->getId() == $main_child_product) {
                                                if ($qty <= 0) {
                                                    $flag = true;
                                                }
                                                break;
                                            }
                                        }
                                    }

                                    if (!$flag)
                                        $totalPointEarn += $pointEarn * $item->getQty();
                                }

                                $price_options = 0;


                                ?>
                                <tr>
                                    <td><a href="<?php echo $product->getProductUrl(true); ?>" class="product-image">
                                            <img src="<?php echo $this->helper('catalog/image')->init($product, 'small_image')->resize(100); ?>"/></a>
                                    </td>
                                    <td>
                                        <a href="<?php echo $product->getProductUrl(true); ?>" class="">
                                            <strong><?php echo $product->getName() ?></strong></a>
                                        <?php if ($product->getTypeId() == 'configurable') { ?>
                                            <?php
                                            $_options = Mage::helper('trubox')->getConfigurableOptionProduct($product);

                                            if ($_options && sizeof($option_params) > 0):?>
                                                <dl class="item-options">
                                                    <?php foreach ($_options as $_option) : ?>
                                                        <?php

                                                        $_attribute_value = 0;
                                                        foreach ($option_params as $k => $v) {
                                                            if ($k == $_option['attribute_id']) {
                                                                $_attribute_value = $v;
                                                                break;
                                                            }
                                                        }

                                                        if ($_attribute_value > 0) {
                                                            ?>
                                                            <dt><?php echo $this->escapeHtml($_option['label']) ?></dt>
                                                            <dd>
                                                                <?php

                                                                foreach ($_option['values'] as $val) {

                                                                    if ($val['value_index'] == $_attribute_value) {
                                                                        echo $val['default_label'];
                                                                        break;
                                                                    }
                                                                }
                                                                ?>
                                                            </dd>
                                                        <?php } ?>
                                                    <?php endforeach; ?>
                                                </dl>
                                            <?php endif; ?>
                                        <?php } else { ?>
                                            <dl class="item-options">
                                                <?php foreach ($product->getOptions() as $o) { ?>
                                                    <?php
                                                    $values = $o->getValues();
                                                    $_attribute_value = 0;

                                                    foreach ($option_params as $k => $v) {
                                                        if ($k == $o->getOptionId()) {
                                                            $_attribute_value = $v;
                                                            break;
                                                        }
                                                    }
                                                    if ($_attribute_value > 0) {
                                                        ?>
                                                        <dt><?php echo $this->escapeHtml($o->getTitle()) ?></dt>
                                                        <dd>
                                                            <?php
                                                            foreach ($values as $val) {
                                                                if (is_array($_attribute_value)) {
                                                                    if (in_array($val->getOptionTypeId(), $_attribute_value)) {
                                                                        echo $val->getTitle() . ' ';
                                                                        $price_options += $val->getPrice();

                                                                    }
                                                                } else if ($val->getOptionTypeId() == $_attribute_value) {
                                                                    echo $val->getTitle() . ' ';
                                                                    $price_options += $val->getPrice();
                                                                }
                                                            }
                                                            ?>
                                                        </dd>
                                                    <?php } ?>
                                                <?php } ?>
                                            </dl>
                                        <?php } ?>
                                        <?php
                                        $itemPrice = ($product->getFinalPrice() + $price_options) * $item->getQty();
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                $totalPrice += $itemPrice;
                                        }
                                        ?>
                                    </td>
                                    <td class="a-center"><input class="product-qty" name="<?php echo $item->getId(); ?>"
                                                                value="<?php echo $item->getQty() ?>"></td>
                                    <td class="a-center"><?php echo $pointEarn * $item->getQty(); ?></td>
                                    <td class="a-center"><p
                                                class="product-price"><?php echo Mage::helper('core')->currency($product->getFinalPrice() + $price_options, true, false); ?></p>
                                    </td>
                                    <td class="a-center"><p
                                                class="total-price"><?php echo Mage::helper('core')->currency($itemPrice, true, false); ?></p>
                                    </td>
                                    <td class="a-center">
                                        <?php
                                        $item_tax_amount = $this->getTaxAmount($product, $item->getQty());
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                $tax += $item_tax_amount;
                                        }
                                        echo Mage::helper('core')->currency($item_tax_amount, true, false); ?>
                                    </td>
                                    <td class="a-center">
                                        <?php
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                echo $this->__("In Stock");
                                            else
                                                echo $this->__("Out of Stock");
                                        } else {
                                            echo $this->__("Out of Stock");
                                        }
                                        ?>
                                    </td>
                                    <td class="a-center"><a href="<?php echo $this->deleteItemsUrl($item->getId()) ?>"
                                                            class="product-price a-center delete-trubox-items"><?php echo $this->__('Delete'); ?></a>
                                    </td>
                                </tr>
                                <?php
                            }
                            ?>
                            </tbody>
                        </table>
                    </div>
                    <div class="total-trubox">
                        <p><?php echo $this->__('Subtotal <span>%s</span>', Mage::helper('core')->currency($totalPrice, true, false)) ?></p>
                        <p><?php echo $this->__('Total Profit Points <span>%s</span>', Mage::helper('rewardpoints/point')->format($totalPointEarn)) ?></p>
                        <p><?php echo $this->__('Tax <span>%s</span>', Mage::helper('core')->currency($tax, true, false)) ?></p>
                        <p><?php echo $this->__('Grand Total <span>%s</span>', Mage::helper('core')->currency($totalPrice + $tax, true, false)) ?></p>
                    </div>
                    <div class="buttons-set">
                        <?php if (sizeof($collection) > 0) { ?>
                            <button class="button btn-cart clear-trubox-items" type="button" id="clear-trubox-items">
                                <span><span><?php echo $this->__('Clear TruBox Items') ?></span></span>
                            </button>
                        <?php } ?>
                        <button class="button btn-cart" type="submit">
                            <span><span><?php echo $this->__('Save Items') ?></span></span>
                        </button>
                    </div>
                </form>
            <?php } else { ?>
                <p><?php echo $this->__('No products found'); ?></p>
            <?php } ?>
        </div>
    </div>
    <hr class="share_separate" />
    <?php if (Mage::helper('trubox')->isEnableOrdersSection()) { ?>
        <div class="box-account box-info box-trubox-summary">
            <div class="trubox-orders">
                <h2 class="trubox-header"><?php echo $this->__('Trubox Orders') ?></h2>
                <?php if (sizeof($orders) > 0) { ?>
                    <form action="#" method="post">
                        <?php echo $this->getPagerHtml() ?> <!--Add Paging-->
                        <table id="trubox-orders" class="data-table">
                            <colgroup>
                                <col width="1">
                                <col>
                                <col width="1">
                                <col width="1">
                                <col>
                            </colgroup>
                            <thead>
                            <tr class="first last">
                                <th><?php echo $this->__('Order #') ?></th>
                                <th><?php echo $this->__('Date') ?></th>
                                <th><?php echo $this->__('Ship To') ?></th>
                                <th><span class="nobr"><?php echo $this->__('Order Total') ?></span></th>
                                <th><span class="nobr"><?php echo $this->__('Order Status') ?></span></th>
                                <th><?php echo $this->__('Action') ?></th>
                            </tr>
                            </thead>
                            <tbody>
                            <?php $_odd = ''; ?>
                            <?php foreach ($orders as $_order): ?>
                                <tr>
                                    <td><?php echo $_order->getRealOrderId() ?></td>
                                    <td><span class="nobr"><?php echo $_order->getCreatedAtStoreDate(); ?></span></td>
                                    <td><?php echo $_order->getShippingAddress() ? $this->escapeHtml($_order->getShippingAddress()->getName()) : '&nbsp;' ?></td>
                                    <td><?php echo $_order->formatPrice($_order->getGrandTotal()) ?></td>
                                    <td><em><?php echo $_order->getStatusLabel() ?></em></td>
                                    <td class="a-center">
                                        <span class="nobr">
                                            <a href="<?php echo Mage::getUrl('sales/order/view', array('order_id' => $_order->getId())); ?>"><?php echo $this->__('View Order') ?></a>
                                        </span>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                            </tbody>
                        </table>
                        <script type="text/javascript">decorateTable('trubox-orders')</script>
                    </form>

                <?php } else { ?>
                    <p><?php echo $this->__('No orders found'); ?></p>
                <?php } ?>
            </div>
        </div>
        <hr class="share_separate">
    <?php } ?>
    <div class="trubox-address">
        <?php
        $shipping_address = $this->getShippingAddressTruBox();
        $billing_address = $this->getBillingAddressTruBox();
        $regions = Mage::getModel('directory/country')->load('US')->getRegions();
        ?>
        <h2 class="trubox-header"><?php echo $this->__('Trubox Address') ?></h2>

        <form class="items" id="trubox-shipping-address" action="<?php echo $this->saveAddressUrl() ?>" method="POST">
            <h2 class="legend"><?php echo $this->__('Billing Address') ?></h2>
            <!-- BILLING ADDRESS -->
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="fields">
                        <div class="customer-name-middlename">
                            <div class="field name-firstname">
                                <label for="firstname" class="required"><em>*</em><?php echo $this->__('First Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="firstname" name="billing[firstname]"
                                           value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getFirstname()) echo $billing_address->getFirstname(); ?>"
                                           title="<?php echo $this->__('First Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                            <div class="field name-lastname">
                                <label for="lastname" class="required"><em>*</em><?php echo $this->__('Last Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="lastname" name="billing[lastname]"
                                           value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getLastname()) echo $billing_address->getLastname(); ?>"
                                           title="<?php echo $this->__('Last Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="wide">
                            <label for="telephone" class="required"><em>*</em><?php echo $this->__('Telephone') ?>
                            </label>

                            <div class="input-box">
                                <input type="tel" name="billing[telephone]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getTelephone()) echo $billing_address->getTelephone(); ?>"
                                       title="<?php echo $this->__('Telephone') ?>" class="input-text required-entry"
                                       id="telephone">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="wide">
                        <label for="street_1" class="required"><em>*</em><?php echo $this->__('Street Address') ?>
                        </label>

                        <div class="input-box">
                            <input type="text" name="billing[street]"
                                   value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address['street']) echo $billing_address['street']; ?>"
                                   title="<?php echo $this->__('Street Address') ?>" id="street_1"
                                   class="input-text  required-entry">
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="zip" class="required"><em>*</em><?php echo $this->__('Zip/Postal Code') ?>
                            </label>

                            <div class="input-box">
                                <input type="text" name="billing[zipcode]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getZipcode()) echo $billing_address->getZipcode(); ?>"
                                       title="Zip/Postal Code" id="zip"
                                       class="input-text validate-zip-international  required-entry">
                            </div>
                        </div>
                        <div class="field">
                            <label for="country" class="required"><em>*</em><?php echo $this->__('Country') ?></label>

                            <div class="input-box">
                                <?php echo $this->getCountryHtmlSelect('billing') ?>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="city" class="required"><em>*</em><?php echo $this->__('City') ?></label>

                            <div class="input-box">
                                <input type="text" name="billing[city]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getCity()) echo $billing_address->getCity(); ?>"
                                       title="City" class="input-text  required-entry" id="city">
                            </div>
                        </div>
                        <div class="field">
                            <label for="region_id" class="required"><em>*</em><?php echo $this->__('State/Province') ?>
                            </label>

                            <div class="state-section">
                                <select name="billing[region]" id="billing_region"
                                        class="state input-text required-entry">
                                    <?php
                                    foreach ($regions as $region) {
                                        if ($billing_address != null && $billing_address->getId() && $billing_address->getRegionId() && $billing_address->getRegionId() == $region->getId())
                                            echo "<option value=" . $region['name'] . " title=" . $region->getId() . " selected='selected'>" . $region['name'] . "</option>";
                                        else
                                            echo "<option value=" . $region['name'] . " title=" . $region->getId() . ">" . $region['name'] . "</option>";
                                    }
                                    ?>
                                </select>
                                <input type="hidden" id="billing_region_id" name="billing[region_id]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getRegionId()) echo $billing_address->getRegionId(); ?>"/>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- SHIPPING ADDRESS -->
            <h2 class="legend shipping"><?php echo $this->__('Shipping Address') ?></h2>

            <div class="fieldsets">
                <ul class="form-list">
                    <li class="fields">
                        <div class="customer-name-middlename">
                            <div class="field name-firstname">
                                <label for="firstname" class="required"><em>*</em><?php echo $this->__('First Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="firstname" name="shipping[firstname]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getFirstname()) echo $shipping_address->getFirstname(); ?>"
                                           title="<?php echo $this->__('First Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                            <div class="field name-lastname">
                                <label for="lastname" class="required"><em>*</em><?php echo $this->__('Last Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="lastname" name="shipping[lastname]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getLastname()) echo $shipping_address->getLastname(); ?>"
                                           title="<?php echo $this->__('Last Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="wide">
                            <label for="telephone" class="required"><em>*</em><?php echo $this->__('Telephone') ?>
                            </label>

                            <div class="input-box">
                                <input type="tel" name="shipping[telephone]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getTelephone()) echo $shipping_address->getTelephone(); ?>"
                                       title="<?php echo $this->__('Telephone') ?>" class="input-text required-entry"
                                       id="telephone">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="wide">
                        <label for="street_1" class="required"><em>*</em><?php echo $this->__('Street Address') ?>
                        </label>

                        <div class="input-box">
                            <input type="text" name="shipping[street]"
                                   value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getStreet()) echo $shipping_address->getStreet(); ?>"
                                   title="<?php echo $this->__('Street Address') ?>" id="street_1"
                                   class="input-text  required-entry">
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="zip" class="required"><em>*</em><?php echo $this->__('Zip/Postal Code') ?>
                            </label>

                            <div class="input-box">
                                <input type="text" name="shipping[zipcode]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getZipcode()) echo $shipping_address->getZipcode(); ?>"
                                       title="Zip/Postal Code" id="zip"
                                       class="input-text validate-zip-international  required-entry">
                            </div>
                        </div>
                        <div class="field">
                            <label for="country" class="required"><em>*</em><?php echo $this->__('Country') ?></label>

                            <div class="input-box">
                                <?php echo $this->getCountryHtmlSelect('shipping') ?>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="city" class="required"><em>*</em><?php echo $this->__('City') ?></label>

                            <div class="input-box">
                                <input type="text" name="shipping[city]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getCity()) echo $shipping_address->getCity(); ?>"
                                       title="City" class="input-text  required-entry" id="city">
                            </div>
                        </div>
                        <div class="field">
                            <label for="region_id" class="required"><em>*</em><?php echo $this->__('State/Province') ?>
                            </label>

                            <div class="state-section">
                                <div class="state-section">
                                    <select name="shipping[region]" id="shipping_region"
                                            class="state input-text required-entry">
                                        <?php
                                        foreach ($regions as $region) {
                                            if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getRegionId() && $shipping_address->getRegionId() == $region->getId())
                                                echo "<option value=" . $region['name'] . " title=" . $region->getId() . " selected='selected'>" . $region['name'] . "</option>";
                                            else
                                                echo "<option value=" . $region['name'] . " title=" . $region->getId() . ">" . $region['name'] . "</option>";
                                        }
                                        ?>
                                    </select>
                                    <input type="hidden" id="shipping_region_id" name="shipping[region_id]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getRegionId()) echo $shipping_address->getRegionId(); ?>"/>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="buttons-set">
                <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                <button class="button btn-cart" type="submit">
                    <span><span><?php echo $this->__('Save Address') ?></span></span>
                </button>
            </div>
        </form>
    </div>
    <hr class="share_separate">
    <div class="trubox-payment">
        <?php
        $payment = $this->getPaymentTruBox();
        $paymentList = array('AE' => 'American Express', 'VI' => 'Visa', 'MC' => 'MasterCard', 'DI' => 'Discover');
        $monthList = array('1' => '01 - January', '2' => '02 - February', '3' => '03 - March', '4' => '04 - April',
            '5' => '05 - May', '6' => '06 - June', '7' => '07 - July', '8' => '08 - August', '9' => '09 - September',
            '10' => '10 - October', '11' => '11 - November', '12' => '12 - December',);
        $yearList = array();
        $yearNow = date("Y");
        for ($i = 0; $i < 10; $i++) {
            $yearList[$yearNow + $i] = $yearNow + $i;
        }
        ?>
        <h2 class="trubox-header"><?php echo $this->__('Trubox Payment') ?></h2>

        <div class="fieldsets">
            <form class="items" id="trubox-payment-information" action="<?php echo $this->savePaymentUrl() ?>"
                  method="POST">
                <ul class="form-list" id="payment_form_ccsave">
                    <?php if($payment->getCardNumber() != null){?>
                    <li>
                        <label for="current_credit_card"><?php echo $this->__('Credit Card')?></label>
                        <select id="current_credit_card" name="current_credit_card">
                            <option value="0"><?php echo $payment->getNameOnCard();?>, <?php echo $paymentList[$payment->getCardType()]?>, <?php echo '************' . substr($payment->getCardNumber(), 12, strlen($payment->getCardNumber()));?></option>
                            <option value="1"><?php echo $this->__('Add new the Credit Card')?></option>
                        </select>
                    </li>
                    <?php }?>
                    <li class="ccc_content">
                        <label for="ccsave_cc_owner" class="required"><em>*</em><?php echo $this->__('Name on Card') ?>
                        </label>

                        <div class="input-box">
                            <input type="text" title="Name on Card" class="input-text required-entry"
                                   id="ccsave_cc_owner"
                                   name="name_on_card"
                                   value="">
                        </div>
                    </li>
                    <li class="ccc_content">
                        <label for="ccsave_cc_type"
                               class="required"><em>*</em><?php echo $this->__('Credit Card Type') ?></label>

                        <div class="input-box">
                            <select id="ccsave_cc_type" name="card_type" title="Credit Card Type"
                                    class="required-entry validate-cc-type-select">
                                <option value=""><?php echo $this->__('--Please Select--'); ?></option>
                                <?php
                                foreach ($paymentList as $k => $v) {
                                    ?>
                                    <option
                                            value="<?php echo $k ?>"><?php echo $v ?></option>
                                    <?php
                                }
                                ?>
                            </select>
                        </div>
                    </li>
                    <li class="ccc_content">
                        <label for="ccsave_cc_number"
                               class="required"><em>*</em><?php echo $this->__('Credit Card Number') ?></label>

                        <div class="input-box">
                            <input type="text" id="ccsave_cc_number" name="card_number" title="Credit Card Number"
                                   class="input-text validate-cc-number validate-cc-type"
                                   value="">
                        </div>
                    </li>
                    <li class="fields ccc_content">
                        <div class="field">
                            <label for="ccsave_expiration"
                                   class="required"><em>*</em><?php echo $this->__('Expiration Date'); ?></label>

                            <div class="input-box">
                                <div class="v-fix">
                                    <select id="ccsave_expiration" name="month_expire"
                                            class="month validate-cc-exp required-entry">
                                        <option value="" selected="selected"><?php echo $this->__('Month') ?></option>
                                        <?php
                                        foreach ($monthList as $k => $v) {
                                            ?>
                                            <option
                                                    value="<?php echo $k ?>"><?php echo $v ?></option>
                                            <?php
                                        }
                                        ?>
                                    </select>
                                </div>
                                <div class="v-fix">
                                    <select id="ccsave_expiration_yr" name="year_expire" class="year required-entry">
                                        <option value=""><?php echo $this->__('Year') ?></option>
                                        <?php
                                        foreach ($yearList as $k => $v) {
                                            ?>
                                            <option
                                                    value="<?php echo $k ?>"><?php echo $v ?></option>
                                            <?php
                                        }
                                        ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <label for="ccsave_cc_cid"
                                   class="required"><em>*</em><?php echo $this->__('Card Verification Number') ?>
                            </label>

                            <div class="input-box">
                                <div class="v-fix">
                                    <input type="text" title="Card Verification Number"
                                           class="input-text cvv required-entry validate-cc-cvn" id="ccsave_cc_cid"
                                           name="cvv"
                                           value="">
                                    <a href="#" class="cvv-what-is-this">What is this?</a>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="input-box apply_trugiftcard">
                            <input type="checkbox" id="use_trugiftcard" name="use_trugiftcard" title="<?php echo $this->__('Use Trunited Gift Card') ?>"
                                   <?php if($is_applied_tgc){?>checked="checked"<?php }?>
                                />

                            <label for="use_trugiftcard"><?php echo $this->__('Apply Trunited Gift Card balance when available') ?></label>
                            <img src="<?php echo $this->getSkinUrl('images/onestepcheckout/flatnew/trugiftcard.png');?>" title="<?php echo $this->__('Trunited Gift Card balance');?>" />
                        </div>
                    </li>
                </ul>
                <div class="buttons-set">
                    <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                    <button class="button btn-cart" type="submit">
                        <span><span><?php echo $this->__('Save Payment') ?></span></span>
                    </button>
                </div>
                <form>
        </div>
    </div>
    <?php echo $this->getChildHtml('other') ?>
</div>
<?php if($payment->getCardNumber() != null){?>
    <style type="text/css">
        .ccc_content{display: none;}
    </style>
    <script type="text/javascript">
        $j = jQuery.noConflict();
        $j('#current_credit_card').change(function() {
            if($j(this).val() == 1){
                $j('.ccc_content').css({'display':'block'});
                $j('#ccsave_cc_owner').addClass(' required-entry');
                $j('#ccsave_cc_type').addClass(' required-entry');
                $j('#ccsave_cc_type').addClass(' validate-cc-type-select');
                $j('#ccsave_cc_number').addClass(' validate-cc-type');
                $j('#ccsave_cc_number').addClass(' validate-cc-number');
                $j('#ccsave_expiration').addClass(' validate-cc-exp');
                $j('#ccsave_expiration').addClass(' required-entry');
                $j('#ccsave_expiration_yr').addClass(' required-entry');
                $j('#ccsave_cc_cid').addClass(' required-entry');
                $j('#ccsave_cc_cid').addClass(' validate-cc-cvn');
            } else {
                $j('.ccc_content').css({'display':'none'});
                $j('#ccsave_cc_owner').removeClass('required-entry');
                $j('#ccsave_cc_type').removeClass('required-entry');
                $j('#ccsave_cc_type').removeClass('validate-cc-type-select');
                $j('#ccsave_cc_number').removeClass('validate-cc-type');
                $j('#ccsave_cc_number').removeClass('validate-cc-number');
                $j('#ccsave_expiration').removeClass('validate-cc-exp');
                $j('#ccsave_expiration').removeClass('required-entry');
                $j('#ccsave_expiration_yr').removeClass('required-entry');
                $j('#ccsave_cc_cid').removeClass('required-entry');
                $j('#ccsave_cc_cid').removeClass('validate-cc-cvn');
            }
        });
        $j(document).ready(function(){
            $j('.ccc_content').css({'display':'none'});
            $j('#ccsave_cc_owner').removeClass('required-entry');
            $j('#ccsave_cc_type').removeClass('required-entry');
            $j('#ccsave_cc_type').removeClass('validate-cc-type-select');
            $j('#ccsave_cc_number').removeClass('validate-cc-type');
            $j('#ccsave_cc_number').removeClass('validate-cc-number');
            $j('#ccsave_expiration').removeClass('validate-cc-exp');
            $j('#ccsave_expiration').removeClass('required-entry');
            $j('#ccsave_expiration_yr').removeClass('required-entry');
            $j('#ccsave_cc_cid').removeClass('required-entry');
            $j('#ccsave_cc_cid').removeClass('validate-cc-cvn');
        });
    </script>
<?php }?>
<div class="tool-tip" id="payment-tool-tip" style="display: none">
    <div class="btn-close"><a href="#" id="payment-tool-tip-close" title="Close">Close</a></div>
    <div class="tool-tip-content"><img src="https://trunited.com/skin/frontend/base/default/images/cvv.gif"
                                       alt="Card Verification Number Visual Reference"
                                       title="Card Verification Number Visual Reference"></div>
</div>
<script type="text/javascript">
    var trubox_items = new VarienForm('trubox-items', true);
    var trubox_shipping_address = new VarienForm('trubox-shipping-address', true);
    var trubox_billing_address = new VarienForm('trubox-billing-address', true);
    var trubox_payment_information = new VarienForm('trubox-payment-information', true);
    var trubox_coupon_code = new VarienForm('trubox-coupon-code', true);

    $j = jQuery.noConflict();
    $j('.page-title').focus();

    $j('.delete-trubox-items').click(function () {
        var rs = confirm('<?php echo $this->__('Are you sure?');?>');
        if (!rs)
            return false;
    });

    $j('#clear-trubox-items').click(function () {
        var rs = confirm('<?php echo $this->__('Are you sure?');?>');
        if (!rs)
            return false;
        else
            window.location.href = '<?php echo $this->getUrl('trubox/index/clearItems');?>';
    });

    $j('#billing_region').change(function () {
        var opt = $j(this).find('option:selected');
        $j('#billing_region_id').val(opt.attr('title'));
    });

    $j('#shipping_region').change(function () {
        var opt = $j(this).find('option:selected');
        $j('#shipping_region_id').val(opt.attr('title'));
    });

    function toggleToolTip(event) {
        if ($('payment-tool-tip')) {
            $('payment-tool-tip').setStyle({
//                top: '200px'//,
                top: (Event.pointerY(event) - 560) + 'px'//,
                //left: (Event.pointerX(event)+100)+'px'
            })
            $('payment-tool-tip').toggle();
        }
        Event.stop(event);
    }
    if ($('payment-tool-tip-close')) {
        Event.observe($('payment-tool-tip-close'), 'click', toggleToolTip);
    }

    $$('.cvv-what-is-this').each(function (element) {
        Event.observe(element, 'click', toggleToolTip);
    });

    jQuery('#country-trubox1').change(function () {
        var countryCode = jQuery('#country-trubox1')[0].selectedOptions[0].value;
        jQuery.ajax({
            type: 'POST',
            url: '<?php echo $this->getRegionHtml() ?>',
            data: {code: countryCode},
            success: function (data) {
                if (data.indexOf("option") >= 0) {
                    jQuery('.state-section').html(data);
                } else {
                    jQuery('.state-section').html("<input type='text' name='state' class='state input-text required-entry' />");
                }
            }
        });
    });
</script>

