<?php
/**
 * Magestore
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magestore.com license that is
 * available through the world-wide-web at this URL:
 * http://www.magestore.com/license-agreement.html
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Magestore
 * @package     Magestore_RewardPoints
 * @copyright   Copyright (c) 2012 Magestore (http://www.magestore.com/)
 * @license     http://www.magestore.com/license-agreement.html
 */

/**
 * Rewardpoints Account Dashboard
 *
 * @see Magestore_RewardPoints_Block_Account_Dashboard
 */
?>
<?php
$collection = $this->getTruBox();
$logo = $this->getLogo();
$orders = $this->getCollection();
$truBox = Mage::helper('trubox')->getCurrentTruBox();
$is_applied_tgc = false;
if ($truBox != null)
    $is_applied_tgc = $truBox->getData('use_trugiftcard') == 1 ? true : false;

?>
<div class="trubox-page">
    <?php echo $this->getChildHtml('global_messages'); ?>
    <?php if (Mage::helper('core')->isModuleOutputEnabled('Magestore_TruWallet') && Mage::helper('truwallet')->isShowWarningMessage()) { ?>
        <?php if (Mage::helper('truwallet')->getWarningMessage() != null) { ?>
            <ul class="messages">
                <li class="notice-msg">
                    <ul>
                        <li><span><?php echo Mage::helper('truwallet')->getWarningMessage(); ?></span></li>
                    </ul>
                </li>
            </ul>

        <?php } ?>
    <?php } ?>
    <div class="page-title" tabindex="1">
        <h1><?php echo $this->__('My TruBox') ?></h1>
    </div>

    <div class="info-summary">
        <?php if ($logo != null) { ?>
            <img
                src="<?php echo Mage::getBaseUrl('media') . 'trubox' . DS . Mage::getStoreConfig('trubox/general/logo'); ?>">
        <?php } else { ?>
            <img src="<?php echo Mage::getBaseUrl('media') . 'trubox/no_image.png'; ?>">
        <?php } ?>
    </div>

    <div class="page-description">
        <?php
        echo Mage::getModel('cms/block')->load('trubox_description')->getContent();
        ?>
    </div>
    <br style="clear: both"/>
    <?php if ($this->isEnableCouponCode()) { ?>
        <hr class="share_separate"/>
        <div class="trubox-coupon-code">
            <h2 class="trubox-header"><?php echo $this->__('TruBox Promotion Code') ?></h2>
            <?php $code = $this->hasCouponCode(); ?>
            <form class="items" id="trubox-coupon-code" action="<?php echo $this->saveCouponCodeUrl() ?>" method="POST">
                <?php if ($code == null) { ?>
                    <div class="fieldsets">
                        <ul class="form-list">
                            <li class="fields">
                                <div class="wide">
                                    <label for="telephone" class="required"><em>*</em>
                                        <?php echo $this->__('Enter promotion code') ?>
                                    </label>

                                    <div class="input-box">
                                        <input type="text" name="coupon_code" value=""
                                               title="<?php echo $this->__('The promotion code') ?>"
                                               class="input-text required-entry"
                                               id="coupon_code"
                                               placeholder="<?php echo $this->__('Enter the promotion code') ?>">
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="buttons-set">
                        <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                        <button class="button btn-cart" type="submit">
                            <span><span><?php echo $this->__('Save Promotion Code') ?></span></span>
                        </button>
                    </div>
                <?php } else { ?>
                    <p><?php echo Mage::helper('trubox')->__('Your promotion code is: <b>%s</b>', strtoupper($code->getCouponCode())); ?></p>
                <?php } ?>
            </form>
        </div>
    <?php } ?>
    <hr class="share_separate"/>
    <div class="box-account box-info box-trubox-summary">
        <div class="trubox-items">
            <h2 class="trubox-header"><?php echo $this->__('Trubox Items') ?></h2>
            <?php if (sizeof($collection) > 0) { ?>
                <form class="items" action="<?php echo $this->saveItemsUrl() ?>" method="POST" id="trubox-items">
                    <div class="table-responsive">
                        <table id="shopping-cart-table" class="table table-condensed">
                            <thead>
                            <tr>
                                <th><span class="nobr"><?php echo $this->__('') ?></span></th>
                                <th><span class="nobr"><?php echo $this->__('Product Image') ?></span></th>
                                <th><span class="nobr"><?php echo $this->__('Name') ?></span></th>
                                <th>
                                    <?php echo $this->__('Qty') ?>
                                </th>
                                <th>
                                    <span class="nobr"><?php echo $this->__('Points') ?></span></span>
                                </th>
                                <th>
                                    <span class="nobr"><?php echo $this->__('Price') ?></span></span>
                                </th>
                                <th>
                                    <span class="nobr"><?php echo $this->__('Total Price') ?></span></span>
                                </th>
                                <th>
                                    <span class="nobr"><?php echo $this->__('Tax Amount') ?></span></span>
                                </th>
                                <th>
                                    <span class="nobr"><?php echo $this->__('Status') ?></span></span>
                                </th>
                                <th>
                                    <span class="nobr"><span><?php echo $this->__('Action') ?></span></span>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <?php
                            $totalPointEarn = 0;
                            $totalPrice = 0;
                            $tax = 0;
                            foreach ($collection as $item) {
                                $product = Mage::getModel('catalog/product')->load($item->getProductId());
                                $pointEarn = $this->getPointEarning($product);
                                $option_params = json_decode($item->getOptionParams(), true);
                                if ($product->getStockItem()->getIsInStock()) {
                                    $flag = false;
                                    if ($product->getTypeId() == 'configurable') {
                                        $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                            ->getProductByAttributes($option_params, $product)->getId();
                                        $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                        foreach ($childProducts as $childProduct) {
                                            $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                            if ($childProduct->getId() == $main_child_product) {
                                                if ($qty <= 0) {
                                                    $flag = true;
                                                }
                                                break;
                                            }
                                        }
                                    }

                                    if (!$flag)
                                        $totalPointEarn += $pointEarn * $item->getQty();
                                }

                                $price_options = 0;


                                ?>
                                <tr>
                                    <td>
                                        <input type="checkbox" name="type_<?php echo $item->getId(); ?>"
                                               id="one_time_<?php echo $item->getId(); ?>"
                                               value="<?php echo Magestore_TruBox_Model_Type::TYPE_ONE_TIME ?>"
                                               class="item_<?php echo $item->getId(); ?>"
                                               title="<?php echo Mage::helper('trubox')->__('One Time Shipment') ?>"
                                               onchange="selectType(this, this.checked)"
                                               <?php if ($item->getTypeItem() == Magestore_TruBox_Model_Type::TYPE_ONE_TIME){ ?>checked="checked"<?php } ?> />
                                        <input type="checkbox" name="type_<?php echo $item->getId(); ?>"
                                               id="every_month_<?php echo $item->getId(); ?>"
                                               value="<?php echo Magestore_TruBox_Model_Type::TYPE_EVERY_MONTH ?>"
                                               class="item_<?php echo $item->getId(); ?>"
                                               title="<?php echo Mage::helper('trubox')->__('Every Month') ?>"
                                               onchange="selectType(this, this.checked)"
                                               <?php if ($item->getTypeItem() == Magestore_TruBox_Model_Type::TYPE_EVERY_MONTH){ ?>checked="checked"<?php } ?> />
                                        <input type="checkbox" name="type_<?php echo $item->getId(); ?>"
                                               id="every_two_months_<?php echo $item->getId(); ?>"
                                               value="<?php echo Magestore_TruBox_Model_Type::TYPE_EVERY_TWO_MONTHS ?>"
                                               class="item_<?php echo $item->getId(); ?>"
                                               title="<?php echo Mage::helper('trubox')->__('Every Two Months') ?>"
                                               onchange="selectType(this, this.checked)"
                                               <?php if ($item->getTypeItem() == Magestore_TruBox_Model_Type::TYPE_EVERY_TWO_MONTHS){ ?>checked="checked"<?php } ?> />
                                    </td>
                                    <td><a href="<?php echo $product->getProductUrl(true); ?>" class="product-image">
                                            <img
                                                src="<?php echo $this->helper('catalog/image')->init($product, 'small_image')->resize(100); ?>"/></a>
                                    </td>
                                    <td>
                                        <a href="<?php echo $product->getProductUrl(true); ?>" class="">
                                            <strong><?php echo $product->getName() ?></strong></a>
                                        <?php if ($product->getTypeId() == 'configurable') { ?>
                                            <?php
                                            $_options = Mage::helper('trubox')->getConfigurableOptionProduct($product);

                                            if ($_options && sizeof($option_params) > 0):?>
                                                <dl class="item-options">
                                                    <?php foreach ($_options as $_option) : ?>
                                                        <?php

                                                        $_attribute_value = 0;
                                                        foreach ($option_params as $k => $v) {
                                                            if ($k == $_option['attribute_id']) {
                                                                $_attribute_value = $v;
                                                                break;
                                                            }
                                                        }

                                                        if ($_attribute_value > 0) {
                                                            ?>
                                                            <dt><?php echo $this->escapeHtml($_option['label']) ?></dt>
                                                            <dd>
                                                                <?php

                                                                foreach ($_option['values'] as $val) {

                                                                    if ($val['value_index'] == $_attribute_value) {
                                                                        echo $val['default_label'];
                                                                        break;
                                                                    }
                                                                }
                                                                ?>
                                                            </dd>
                                                        <?php } ?>
                                                    <?php endforeach; ?>
                                                </dl>
                                            <?php endif; ?>
                                        <?php } else { ?>
                                            <dl class="item-options">
                                                <?php foreach ($product->getOptions() as $o) { ?>
                                                    <?php
                                                    $values = $o->getValues();
                                                    $_attribute_value = 0;

                                                    foreach ($option_params as $k => $v) {
                                                        if ($k == $o->getOptionId()) {
                                                            $_attribute_value = $v;
                                                            break;
                                                        }
                                                    }
                                                    if ($_attribute_value > 0) {
                                                        ?>
                                                        <dt><?php echo $this->escapeHtml($o->getTitle()) ?></dt>
                                                        <dd>
                                                            <?php
                                                            foreach ($values as $val) {
                                                                if (is_array($_attribute_value)) {
                                                                    if (in_array($val->getOptionTypeId(), $_attribute_value)) {
                                                                        echo $val->getTitle() . ' ';
                                                                        $price_options += $val->getPrice();

                                                                    }
                                                                } else if ($val->getOptionTypeId() == $_attribute_value) {
                                                                    echo $val->getTitle() . ' ';
                                                                    $price_options += $val->getPrice();
                                                                }
                                                            }
                                                            ?>
                                                        </dd>
                                                    <?php } ?>
                                                <?php } ?>
                                            </dl>
                                        <?php } ?>
                                        <?php
                                        $itemPrice = ($product->getFinalPrice() + $price_options) * $item->getQty();
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                $totalPrice += $itemPrice;
                                        }
                                        ?>
                                    </td>
                                    <td class="a-center">
                                        <input class="product-qty" id="item_<?php echo $item->getId(); ?>"
                                               name="<?php echo $item->getId(); ?>"
                                               value="<?php echo $item->getQty() ?>"/>
                                        <input type="button" id="minus" value="-"
                                               onClick="minusQty(item_<?php echo $item->getId(); ?>)">
                                        <input type="button" value="+"
                                               onClick="plusQty(item_<?php echo $item->getId(); ?>)"/>
                                    </td>
                                    <td class="a-center"><?php echo $pointEarn * $item->getQty(); ?></td>
                                    <td class="a-center"><p
                                            class="product-price"><?php echo Mage::helper('core')->currency($product->getFinalPrice() + $price_options, true, false); ?></p>
                                    </td>
                                    <td class="a-center"><p
                                            class="total-price"><?php echo Mage::helper('core')->currency($itemPrice, true, false); ?></p>
                                    </td>
                                    <td class="a-center">
                                        <?php
                                        $item_tax_amount = $this->getTaxAmount($product, $item->getQty());
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                $tax += $item_tax_amount;
                                        }
                                        echo Mage::helper('core')->currency($item_tax_amount, true, false); ?>
                                    </td>
                                    <td class="a-center">
                                        <?php
                                        if ($product->getStockItem()->getIsInStock()) {
                                            $flag = false;
                                            if ($product->getTypeId() == 'configurable') {
                                                $main_child_product = Mage::getModel('catalog/product_type_configurable')
                                                    ->getProductByAttributes($option_params, $product)->getId();
                                                $childProducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $product);
                                                foreach ($childProducts as $childProduct) {
                                                    $qty = Mage::getModel('cataloginventory/stock_item')->loadByProduct($childProduct)->getQty();
                                                    if ($childProduct->getId() == $main_child_product) {
                                                        if ($qty <= 0) {
                                                            $flag = true;
                                                        }
                                                        break;
                                                    }
                                                }
                                            }

                                            if (!$flag)
                                                echo $this->__("In Stock");
                                            else
                                                echo $this->__("Out of Stock");
                                        } else {
                                            echo $this->__("Out of Stock");
                                        }
                                        ?>
                                    </td>
                                    <td class="a-center"><a href="<?php echo $this->deleteItemsUrl($item->getId()) ?>"
                                                            class="product-price a-center delete-trubox-items"><?php echo $this->__('Delete'); ?></a>
                                    </td>
                                </tr>
                                <?php
                            }
                            ?>
                            </tbody>
                        </table>
                    </div>
                    <div class="total-trubox">
                        <p><?php echo $this->__('Subtotal <span>%s</span>', Mage::helper('core')->currency($totalPrice, true, false)) ?></p>

                        <p><?php echo $this->__('Total Profit Points <span>%s</span>', Mage::helper('rewardpoints/point')->format($totalPointEarn)) ?></p>

                        <p><?php echo $this->__('Tax <span>%s</span>', Mage::helper('core')->currency($tax, true, false)) ?></p>

                        <p><?php echo $this->__('Grand Total <span>%s</span>', Mage::helper('core')->currency($totalPrice + $tax, true, false)) ?></p>
                    </div>
                    <div class="buttons-set">
                        <?php if (sizeof($collection) > 0) { ?>
                            <button class="button btn-cart clear-trubox-items" type="button" id="clear-trubox-items">
                                <span><span><?php echo $this->__('Clear TruBox Items') ?></span></span>
                            </button>
                        <?php } ?>
                        <button class="button btn-cart" type="submit">
                            <span><span><?php echo $this->__('Save Items') ?></span></span>
                        </button>
                    </div>
                    <div class="buttons-set" id="points_cost">
                        <?php
                        $is_current = false;
                        if ($this->isShowCurrentMonth()) {
                            $data_first = $this->getDataCurrentMonth();
                            $data_second = $this->getDataNextMonth(1);
                            $data_third = $this->getDataNextMonth(2);
                            $is_current = true;
                        } else {
                            $data_first = $this->getDataNextMonth(1);
                            $data_second = $this->getDataNextMonth(2);
                            $data_third = $this->getDataNextMonth(3);
                        };
                        ?>
                        <hr/>
                        <strong><?php if ($is_current) {
                                echo date('F', time());
                            } else echo date('F', strtotime('+1 month')); ?></strong>

                        <div class="current_month">
                            <div>
                                <label for="current_month_points">Current Points: </label>
                                <span id="current_month_points"><?php echo $data_first['points']; ?></span>
                            </div>

                            <div>
                                <label for="current_month_cost">Current Cost: </label>
                                <span
                                    id="current_month_cost"><?php echo Mage::helper('core')->currency($data_first['cost'], true, false) ?></span>
                            </div>
                        </div>
                        <hr/>
                        <strong><?php if ($is_current) {
                                echo date('F', strtotime('+1 month'));
                            } else echo date('F', strtotime('+2 month')); ?></strong>

                        <div class="monthly">
                            <div>
                                <label for="monthly_points">Monthly Points: </label>
                                <span id="monthly_points"><?php echo $data_second['points']; ?></span>
                            </div>

                            <div>
                                <label for="monthly_cost">Monthly Cost: </label>
                                <span
                                    id="monthly_cost"><?php echo Mage::helper('core')->currency($data_second['cost'], true, false) ?></span>
                            </div>
                        </div>
                        <hr/>
                        <strong><?php if ($is_current) {
                                echo date('F', strtotime('+2 month'));
                            } else echo date('F', strtotime('+3 month')); ?></strong>

                        <div class="two_month">
                            <div>
                                <label for="two_month_points">Every 2 Months Points: </label>
                                <span id="two_month_points"><?php echo $data_third['points']; ?></span>
                            </div>

                            <div>
                                <label for="two_month_cost">Every 2 Months Cost: </label>
                                <span
                                    id="two_month_cost"><?php echo Mage::helper('core')->currency($data_third['cost'], true, false) ?></span>
                            </div>
                        </div>
                    </div>
                </form>
            <?php } else { ?>
                <p><?php echo $this->__('No products found'); ?></p>
            <?php } ?>
        </div>
    </div>
    <hr class="share_separate"/>
    <?php if (Mage::helper('trubox')->isEnableOrdersSection()) { ?>
        <div class="box-account box-info box-trubox-summary">
            <div class="trubox-orders">
                <h2 class="trubox-header"><?php echo $this->__('Trubox Orders') ?></h2>
                <?php if (sizeof($orders) > 0) { ?>
                    <form action="#" method="post">
                        <?php echo $this->getPagerHtml() ?> <!--Add Paging-->
                        <table id="trubox-orders" class="data-table">
                            <colgroup>
                                <col width="1">
                                <col>
                                <col width="1">
                                <col width="1">
                                <col>
                            </colgroup>
                            <thead>
                            <tr class="first last">
                                <th><?php echo $this->__('Order #') ?></th>
                                <th><?php echo $this->__('Date') ?></th>
                                <th><?php echo $this->__('Ship To') ?></th>
                                <th><span class="nobr"><?php echo $this->__('Order Total') ?></span></th>
                                <th><span class="nobr"><?php echo $this->__('Order Status') ?></span></th>
                                <th><?php echo $this->__('Action') ?></th>
                            </tr>
                            </thead>
                            <tbody>
                            <?php $_odd = ''; ?>
                            <?php foreach ($orders as $_order): ?>
                                <tr>
                                    <td><?php echo $_order->getRealOrderId() ?></td>
                                    <td><span class="nobr"><?php echo $_order->getCreatedAtStoreDate(); ?></span></td>
                                    <td><?php echo $_order->getShippingAddress() ? $this->escapeHtml($_order->getShippingAddress()->getName()) : '&nbsp;' ?></td>
                                    <td><?php echo $_order->formatPrice($_order->getGrandTotal()) ?></td>
                                    <td><em><?php echo $_order->getStatusLabel() ?></em></td>
                                    <td class="a-center">
                                        <span class="nobr">
                                            <a href="<?php echo Mage::getUrl('sales/order/view', array('order_id' => $_order->getId())); ?>"><?php echo $this->__('View Order') ?></a>
                                        </span>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                            </tbody>
                        </table>
                        <script type="text/javascript">decorateTable('trubox-orders')</script>
                    </form>

                <?php } else { ?>
                    <p><?php echo $this->__('No orders found'); ?></p>
                <?php } ?>
            </div>
        </div>
        <hr class="share_separate">
    <?php } ?>
    <div class="trubox-address">
        <?php
        $shipping_address = $this->getShippingAddressTruBox();
        $billing_address = $this->getBillingAddressTruBox();
        $regions = Mage::getModel('directory/country')->load('US')->getRegions();
        ?>
        <h2 class="trubox-header"><?php echo $this->__('Trubox Address') ?></h2>

        <form class="items" id="trubox-shipping-address" action="<?php echo $this->saveAddressUrl() ?>" method="POST">
            <h2 class="legend"><?php echo $this->__('Billing Address') ?></h2>
            <!-- BILLING ADDRESS -->
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="fields">
                        <div class="customer-name-middlename">
                            <div class="field name-firstname">
                                <label for="firstname" class="required"><em>*</em><?php echo $this->__('First Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="firstname" name="billing[firstname]"
                                           value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getFirstname()) echo $billing_address->getFirstname(); ?>"
                                           title="<?php echo $this->__('First Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                            <div class="field name-lastname">
                                <label for="lastname" class="required"><em>*</em><?php echo $this->__('Last Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="lastname" name="billing[lastname]"
                                           value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getLastname()) echo $billing_address->getLastname(); ?>"
                                           title="<?php echo $this->__('Last Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="wide">
                            <label for="telephone" class="required"><em>*</em><?php echo $this->__('Telephone') ?>
                            </label>

                            <div class="input-box">
                                <input type="tel" name="billing[telephone]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getTelephone()) echo $billing_address->getTelephone(); ?>"
                                       title="<?php echo $this->__('Telephone') ?>" class="input-text required-entry"
                                       id="telephone">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="wide">
                        <label for="street_1" class="required"><em>*</em><?php echo $this->__('Street Address') ?>
                        </label>

                        <div class="input-box">
                            <input type="text" name="billing[street]"
                                   value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address['street']) echo $billing_address['street']; ?>"
                                   title="<?php echo $this->__('Street Address') ?>" id="street_1"
                                   class="input-text  required-entry">
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="zip" class="required"><em>*</em><?php echo $this->__('Zip/Postal Code') ?>
                            </label>

                            <div class="input-box">
                                <input type="text" name="billing[zipcode]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getZipcode()) echo $billing_address->getZipcode(); ?>"
                                       title="Zip/Postal Code" id="zip"
                                       class="input-text validate-zip-international  required-entry">
                            </div>
                        </div>
                        <div class="field">
                            <label for="country" class="required"><em>*</em><?php echo $this->__('Country') ?></label>

                            <div class="input-box">
                                <?php echo $this->getCountryHtmlSelect('billing') ?>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="city" class="required"><em>*</em><?php echo $this->__('City') ?></label>

                            <div class="input-box">
                                <input type="text" name="billing[city]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getCity()) echo $billing_address->getCity(); ?>"
                                       title="City" class="input-text  required-entry" id="city">
                            </div>
                        </div>
                        <div class="field">
                            <label for="region_id" class="required"><em>*</em><?php echo $this->__('State/Province') ?>
                            </label>

                            <div class="state-section">
                                <select name="billing[region]" id="billing_region"
                                        class="state input-text required-entry">
                                    <?php
                                    foreach ($regions as $region) {
                                        if ($billing_address != null && $billing_address->getId() && $billing_address->getRegionId() && $billing_address->getRegionId() == $region->getId())
                                            echo "<option value=" . $region['name'] . " title=" . $region->getId() . " selected='selected'>" . $region['name'] . "</option>";
                                        else
                                            echo "<option value=" . $region['name'] . " title=" . $region->getId() . ">" . $region['name'] . "</option>";
                                    }
                                    ?>
                                </select>
                                <input type="hidden" id="billing_region_id" name="billing[region_id]"
                                       value="<?php if ($billing_address != null && $billing_address->getId() && $billing_address->getRegionId()) echo $billing_address->getRegionId(); ?>"/>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- SHIPPING ADDRESS -->
            <h2 class="legend shipping"><?php echo $this->__('Shipping Address') ?></h2>

            <div class="fieldsets">
                <ul class="form-list">
                    <li class="fields">
                        <div class="customer-name-middlename">
                            <div class="field name-firstname">
                                <label for="firstname" class="required"><em>*</em><?php echo $this->__('First Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="firstname" name="shipping[firstname]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getFirstname()) echo $shipping_address->getFirstname(); ?>"
                                           title="<?php echo $this->__('First Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                            <div class="field name-lastname">
                                <label for="lastname" class="required"><em>*</em><?php echo $this->__('Last Name') ?>
                                </label>

                                <div class="input-box">
                                    <input type="text" id="lastname" name="shipping[lastname]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getLastname()) echo $shipping_address->getLastname(); ?>"
                                           title="<?php echo $this->__('Last Name') ?>" maxlength="255"
                                           class="input-text required-entry">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="wide">
                            <label for="telephone" class="required"><em>*</em><?php echo $this->__('Telephone') ?>
                            </label>

                            <div class="input-box">
                                <input type="tel" name="shipping[telephone]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getTelephone()) echo $shipping_address->getTelephone(); ?>"
                                       title="<?php echo $this->__('Telephone') ?>" class="input-text required-entry"
                                       id="telephone">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="fieldsets">
                <ul class="form-list">
                    <li class="wide">
                        <label for="street_1" class="required"><em>*</em><?php echo $this->__('Street Address') ?>
                        </label>

                        <div class="input-box">
                            <input type="text" name="shipping[street]"
                                   value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getStreet()) echo $shipping_address->getStreet(); ?>"
                                   title="<?php echo $this->__('Street Address') ?>" id="street_1"
                                   class="input-text  required-entry">
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="zip" class="required"><em>*</em><?php echo $this->__('Zip/Postal Code') ?>
                            </label>

                            <div class="input-box">
                                <input type="text" name="shipping[zipcode]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getZipcode()) echo $shipping_address->getZipcode(); ?>"
                                       title="<?php echo $this->__('Zip/Postal Code') ?>" id="zip"
                                       class="input-text validate-zip-international  required-entry">
                            </div>
                        </div>
                        <div class="field">
                            <label for="country" class="required"><em>*</em><?php echo $this->__('Country') ?></label>

                            <div class="input-box">
                                <?php echo $this->getCountryHtmlSelect('shipping') ?>
                            </div>
                        </div>
                    </li>
                    <li class="fields">
                        <div class="field">
                            <label for="city" class="required"><em>*</em><?php echo $this->__('City') ?></label>

                            <div class="input-box">
                                <input type="text" name="shipping[city]"
                                       value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getCity()) echo $shipping_address->getCity(); ?>"
                                       title="<?php echo $this->__('City') ?>" class="input-text  required-entry"
                                       id="city">
                            </div>
                        </div>
                        <div class="field">
                            <label for="region_id" class="required"><em>*</em><?php echo $this->__('State/Province') ?>
                            </label>

                            <div class="state-section">
                                <div class="state-section">
                                    <select name="shipping[region]" id="shipping_region"
                                            class="state input-text required-entry">
                                        <?php
                                        foreach ($regions as $region) {
                                            if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getRegionId() && $shipping_address->getRegionId() == $region->getId())
                                                echo "<option value=" . $region['name'] . " title=" . $region->getId() . " selected='selected'>" . $region['name'] . "</option>";
                                            else
                                                echo "<option value=" . $region['name'] . " title=" . $region->getId() . ">" . $region['name'] . "</option>";
                                        }
                                        ?>
                                    </select>
                                    <input type="hidden" id="shipping_region_id" name="shipping[region_id]"
                                           value="<?php if ($shipping_address != null && $shipping_address->getId() && $shipping_address->getRegionId()) echo $shipping_address->getRegionId(); ?>"/>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="buttons-set">
                <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                <button class="button btn-cart" type="submit">
                    <span><span><?php echo $this->__('Save Address') ?></span></span>
                </button>
            </div>
        </form>
    </div>
    <hr class="share_separate">
    <div class="trubox-payment">
        <?php
        $cards = $this->getPaymentTruBox();
        ?>
        <h2 class="trubox-header"><?php echo $this->__('Trubox Payment') ?></h2>

        <div class="fieldsets">
            <form class="items" id="trubox-payment-information" action="<?php echo $this->savePaymentUrl() ?>"
                  method="POST">
                <ul class="form-list" id="payment_form_ccsave">
                    <?php if (sizeof($cards) > 0) { ?>
                        <li>
                            <label for="current_credit_card"><?php echo $this->__('Credit Card') ?></label>
                            <select id="current_credit_card" name="current_credit_card">
                                <?php foreach ($cards as $card) { ?>
                                    <option
                                        value="<?php echo $card->getId(); ?>"><?php echo $card->getLabel(); ?></option>
                                <?php } ?>
                            </select>
                        </li>
                    <?php } else { ?>
                        <input type="hidden" id="current_credit_card" name="current_credit_card" value=""/>
                    <?php } ?>
                    <li>
                        <a href="<?php echo $this->getCardUrl(); ?>"
                           title="<?php echo $this->__('Create, update or use a different card') ?>">
                            <?php echo $this->__('Create, update or use a different card') ?>
                        </a>
                    </li>
                    <li>
                        <div class="input-box apply_trugiftcard">
                            <input type="checkbox" id="use_trugiftcard" name="use_trugiftcard"
                                   title="<?php echo $this->__('Use Trunited Gift Card') ?>"
                                   <?php if ($is_applied_tgc){ ?>checked="checked"<?php } ?>
                                />

                            <label
                                for="use_trugiftcard"><?php echo $this->__('Apply Trunited Gift Card balance when available') ?></label>
                            <img
                                src="<?php echo $this->getSkinUrl('images/onestepcheckout/flatnew/trugiftcard.png'); ?>"
                                title="<?php echo $this->__('Trunited Gift Card balance'); ?>"/>
                        </div>
                    </li>
                </ul>
                <div class="buttons-set">
                    <p class="required"><?php echo $this->__('* Required Fields'); ?></p>
                    <button class="button btn-cart" type="submit">
                        <span><span><?php echo $this->__('Save Payment') ?></span></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <?php echo $this->getChildHtml('other') ?>
</div>

<script type="text/javascript">
    var trubox_items = new VarienForm('trubox-items', true);
    var trubox_shipping_address = new VarienForm('trubox-shipping-address', true);
    var trubox_billing_address = new VarienForm('trubox-billing-address', true);
    var trubox_payment_information = new VarienForm('trubox-payment-information', true);
    var trubox_coupon_code = new VarienForm('trubox-coupon-code', true);
    var update_quantity_url = '<?php echo $this->getUrl('*/*/updatePointCost');?>';

    $j = jQuery.noConflict();
    $j('.page-title').focus();

    $j('.delete-trubox-items').click(function () {
        var rs = confirm('<?php echo $this->__('Are you sure?');?>');
        if (!rs)
            return false;
    });

    $j('#clear-trubox-items').click(function () {
        var rs = confirm('<?php echo $this->__('Are you sure?');?>');
        if (!rs)
            return false;
        else
            window.location.href = '<?php echo $this->getUrl('trubox/index/clearItems');?>';
    });

    $j('#billing_region').change(function () {
        var opt = $j(this).find('option:selected');
        $j('#billing_region_id').val(opt.attr('title'));
    });

    $j('#shipping_region').change(function () {
        var opt = $j(this).find('option:selected');
        $j('#shipping_region_id').val(opt.attr('title'));
    });

    $$('.cvv-what-is-this').each(function (element) {
        Event.observe(element, 'click', toggleToolTip);
    });

    jQuery('#country-trubox1').change(function () {
        var countryCode = jQuery('#country-trubox1')[0].selectedOptions[0].value;
        jQuery.ajax({
            type: 'POST',
            url: '<?php echo $this->getRegionHtml() ?>',
            data: {code: countryCode},
            success: function (data) {
                if (data.indexOf("option") >= 0) {
                    jQuery('.state-section').html(data);
                } else {
                    jQuery('.state-section').html("<input type='text' name='state' class='state input-text required-entry' />");
                }
            }
        });
    });

    function minusQty(item) {
        if (typeof item != 'undefined' && item != null) {
            item.value = (item.value - 1) <= 0 ? 0 : (item.value - 1);
            updateAjax();
        }
    }

    function plusQty(item) {
        if (typeof item != 'undefined' && item != null) {
            item.value = (+item.value + 1);
            updateAjax();
        }
    }

    function selectType(e, v) {
        var _class = '.' + $j(e).attr('class');
        var name = $j(e).attr('name');
        $j(_class).prop('checked', false);
        $j(e).prop('checked', v);

        updateAjax();
    }

    function updateAjax()
    {
        var params = [];
        <?php foreach ($collection as $item) {?>
        var obj = {};
        $j('input[name="type_<?php echo $item->getId();?>"').each(function () {
            if ($j(this).is(':checked')) {
                obj['type_value'] = $j(this).val();
            }
        });
        obj['is_remove'] = $j('input[name="type_<?php echo $item->getId();?>"]:checked').length <= 0;
        obj['item_qty'] = $j('#item_<?php echo $item->getId();?>').val();
        obj['item_id'] = <?php echo $item->getId();?>;
        params.push(obj);
        <?php }?>

        var current_month_points = $j('#current_month_points');
        var current_month_cost = $j('#current_month_cost');

        var monthly_points = $j('#monthly_points');
        var monthly_cost = $j('#monthly_cost');

        var two_month_points = $j('#two_month_points');
        var two_month_cost = $j('#two_month_cost');

        $j('#points_cost').css({opacity: '0.5'});

        $j.ajax({
            url: update_quantity_url,
            type: 'POST',
            data: {data: JSON.stringify(params)},
            success: function (result) {
                var rs = JSON.parse(result);

                if(current_month_points != null){
                    current_month_points.html(rs.first.points);
                }

                if(current_month_cost != null){
                    current_month_cost.html(rs.first.cost);
                }

                if(monthly_points != null){
                    monthly_points.html(rs.second.points);
                }

                if(monthly_cost != null){
                    monthly_cost.html(rs.second.cost);
                }

                if(two_month_points != null){
                    two_month_points.html(rs.third.points);
                }

                if(two_month_cost != null){
                    two_month_cost.html(rs.third.cost);
                }

                $j('#points_cost').css({opacity: '1'});
            }
        });
    }
</script>

